FROM registry.access.redhat.com/ubi9/nodejs-20:latest AS builder

RUN mkdir -p SGXDataCenterAttestationPrimitives/QuoteVerification/QVL
WORKDIR SGXDataCenterAttestationPrimitives
RUN tar xf /cachi2/output/deps/generic/dcap-source.tar.gz --strip-components=1

WORKDIR QuoteVerification/QVL
RUN tar xf /cachi2/output/deps/generic/qvl-source.tar.gz --strip-components=1

WORKDIR ../../tools/PCKCertSelection/
RUN mkdir -p ../../prebuilt/openssl/inc \
    && mkdir -p ../../QuoteGeneration/pccs/lib \
    && make -C PCKCertSelectionLib \
    && cp ./out/libPCKCertSelection.so ../../QuoteGeneration/pccs/lib

WORKDIR ../../QuoteGeneration/pccs
RUN npm config set engine-strict true \
    && npm install

FROM registry.access.redhat.com/ubi9/nodejs-20:latest

WORKDIR intel/pccs
COPY --from=builder --chown=default:1001 /opt/app-root/src/SGXDataCenterAttestationPrimitives/QuoteGeneration/pccs .

ENTRYPOINT ["/usr/bin/node", "pccs_server.js"]
